# AnkiRAG Agent

Десктопное приложение для синхронизации флеш-карточек между AnkiRAG и локальным Anki.

## Что это такое

AnkiRAG Agent — это мост между веб-сервисом AnkiRAG (где создаются и одобряются карточки) и вашим локальным Anki. Приложение работает в фоне, периодически забирает одобренные карточки с сервера и добавляет их в Anki через AnkiConnect.

```
┌─────────────┐      ┌──────────────────┐      ┌─────────────┐
│  AnkiRAG    │ ───► │  AnkiRAG Agent   │ ───► │    Anki     │
│  (сервер)   │ API  │  (это приложение)│      │  (локально) │
└─────────────┘      └──────────────────┘      └─────────────┘
                              │
                              ▼
                     AnkiConnect (localhost:8765)
```

## Возможности

- Автоматическая синхронизация одобренных карточек
- Работа в системном трее (сворачивается, не мешает)
- Безопасное хранение токена в системном keyring
- Обнаружение дубликатов
- Настраиваемый интервал синхронизации

## Требования

| Компонент | Версия | Зачем |
|-----------|--------|-------|
| Python | 3.12+ | Runtime |
| Anki | Любая | Целевое приложение |
| AnkiConnect | Addon | API для Anki |
| AnkiRAG аккаунт | — | Источник карточек |

## Быстрый старт

### 1. Установка AnkiConnect в Anki

```
Anki → Tools → Add-ons → Get Add-ons → Код: 2055492159 → Restart
```

### 2. Установка агента

```bash
cd local-agent

# Вариант A: через uv (рекомендуется)
uv pip install -e .

# Вариант B: через pip
pip install -e .
```

### 3. Запуск

```bash
ankirag-agent
```

### 4. Первичная настройка

1. Нажать **Login**
2. Вставить API-токен из личного кабинета AnkiRAG
3. Убедиться, что Anki запущен
4. Нажать **Sync Now**

## Использование

### Основной сценарий

1. Запустить Anki
2. Запустить `ankirag-agent`
3. Приложение автоматически синхронизирует карточки каждые N минут
4. Закрыть окно — приложение уйдёт в трей

### Системный трей

| Действие | Результат |
|----------|-----------|
| Двойной клик | Открыть окно |
| ПКМ → Sync Now | Запустить синхронизацию |
| ПКМ → Quit | Полностью закрыть |

### Индикаторы статуса

- **Anki: Connected (N decks)** — AnkiConnect работает
- **API: Connected** — Связь с сервером есть
- **Auth: Token stored** — Токен сохранён

## Конфигурация

### Через интерфейс

Кнопка **Settings** открывает диалог настроек:

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| AnkiConnect URL | `localhost:8765` | Адрес AnkiConnect |
| Default Deck | `AnkiRAG` | Колода для новых карточек |
| Default Model | `Basic` | Тип заметки (Basic, Cloze) |
| Auto-sync Interval | `30 мин` | Интервал автосинхронизации (0 = выкл) |
| API Base URL | `localhost:8000` | Адрес сервера AnkiRAG |

### Через переменные окружения

Префикс `ANKIRAG_` + имя параметра в SCREAMING_SNAKE_CASE:

```bash
export ANKIRAG_API_BASE_URL=https://api.ankirag.example.com
export ANKIRAG_SYNC_INTERVAL_MINUTES=15
export ANKIRAG_DEFAULT_DECK=MyDeck

ankirag-agent
```

Или через `.env` файл в директории запуска.

## Архитектура

```
src/
├── main.py                 # Точка входа
│
├── core/                   # Бизнес-логика
│   ├── models.py           # CardData, SyncResult, SyncStatus
│   ├── exceptions.py       # AnkiConnectError, APIError
│   └── sync_service.py     # Логика синхронизации
│
├── clients/                # Внешние API
│   ├── anki_client.py      # AnkiConnect (localhost)
│   └── api_client.py       # AnkiRAG Backend (сервер)
│
├── config/                 # Конфигурация
│   ├── settings.py         # Настройки (pydantic-settings)
│   └── token_manager.py    # Хранение токена (keyring)
│
└── ui/                     # Интерфейс (PyQt6)
    ├── main_window.py      # Главное окно
    ├── dialogs/            # Диалоги (Login, Settings)
    └── workers/            # Фоновые задачи (Sync)
```

### Слои и зависимости

```
ui/ ──────────► core/ ──────────► clients/
     использует       использует
                          │
                          ▼
                      config/
```

- **ui/** — только отображение, делегирует логику в core
- **core/** — бизнес-логика, не знает про UI
- **clients/** — HTTP-клиенты, не знают про бизнес-логику
- **config/** — используется всеми слоями

## Решение проблем

### Anki: Not connected

```
✗ AnkiConnect не отвечает
```

**Решение:**
1. Убедиться, что Anki запущен
2. Проверить, что AnkiConnect установлен: `Tools → Add-ons`
3. Перезапустить Anki

### API: Token invalid

```
✗ Токен не принят сервером
```

**Решение:**
1. Нажать **Login**
2. Получить новый токен в личном кабинете AnkiRAG
3. Вставить и сохранить

### Карточки не появляются

**Проверить:**
1. Есть ли одобренные карточки на сервере?
2. Существует ли колода в Anki?
3. Установлен ли тип заметки (Basic/Cloze)?

**Посмотреть логи:** Activity Log в окне приложения.

### Дубликаты

Агент пытается обнаруживать дубликаты по содержимому Front-поля. Если дубликаты появились:
1. Карточки были созданы вручную до синхронизации
2. Использовать `Browse` в Anki для поиска и удаления

## Безопасность

| Аспект | Реализация |
|--------|------------|
| Хранение токена | Системный keyring (Keychain/Secret Service/Credential Manager) |
| Передача данных | HTTPS (при правильной настройке сервера) |
| Файлы конфигурации | Токен НЕ хранится в файлах |

## Разработка

### Запуск из исходников

```bash
cd local-agent
python -m src.main
```

### Проверка синтаксиса

```bash
python -m py_compile src/**/*.py
```

### Сборка

```bash
uv build
# или
python -m build
```

## Лицензия

Часть проекта AnkiRAG.
